___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Outfindo purchase tag",
  "categories": ["ANALYTICS", "CONVERSIONS", "SESSION_RECORDING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "This template tracks purchases on your website and sends the data to Outfindo statistics.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "items",
    "displayName": "Items",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "GA_TRACKING_ID"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "Currency",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "GA_TRACKING_ID"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "orderId",
    "displayName": "Order ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "GA_TRACKING_ID"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const callInWindow = require('callInWindow');
const getCookie = require('getCookieValues');
const getUrl = require('getUrl');
const injectScript = require('injectScript');
const log = require('logToConsole');
const queryPermission = require('queryPermission');
const setInWindow = require('setInWindow');
const toString = require('makeString');

const cookiesScript = 'https://embed.outfindo.com/cookies.js';
const trackingScript = 'https://embed.outfindo.com/tracking.js';

setInWindow('outfindo', {});

const injectCustomScript = (script, callback) => {
  if (queryPermission('inject_script', script)) {
    injectScript(script, callback, data.gtmOnFailure, script);
  } else {
    log(script + ': Script load failed due to permissions mismatch.');
    data.gtmOnFailure();
  }
};

injectCustomScript(cookiesScript, () => {
  callInWindow('outfindo.getSessionIdCookieValue');
  callInWindow('outfindo.getVisitorIdCookieValue');
  
  injectCustomScript(trackingScript, () => {
    const gaId = toString(getCookie('_ga'));
    const sessionId = toString(getCookie('outfindo-session-id'));
    const visitorId = toString(getCookie('outfindo-visitor-id'));

    const eventData = {
      source_app: getUrl('host'),
      source_url: getUrl(),
      event_type: 'purchase',
      ga_id: !! gaId ?
        gaId.split('.')[2] :
        null,
      session_id: sessionId,
      visitor_id: visitorId,
      region: 'cz',
      locale: 'cs_CZ',
      payload: {
        items: data.items,
        currency: data.currency,
        order_id: data.orderId,
      },
    };
  
    callInWindow('outfindo.trackEvent', eventData);
  });
});

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_ga"
              },
              {
                "type": 1,
                "string": "outfindo-session-id"
              },
              {
                "type": 1,
                "string": "outfindo-visitor-id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "outfindo.getSessionIdCookieValue"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "outfindo.getVisitorIdCookieValue"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "outfindo.trackEvent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "outfindo"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://embed.outfindo.com/cookies.js"
              },
              {
                "type": 1,
                "string": "https://embed.outfindo.com/tracking.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 29. 2. 2024 16:43:36
